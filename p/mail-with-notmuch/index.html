<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content=" Today, we will see how to read and mails locally for fast search. Using the powerful notmuch, a local database will be created. By default, notmuch do not move or remove mails but just operate on tags. 5 steps are needed:\nsynchronize mail locally (mbsync) index and tag mail (notmuch) use an email client (emacs interface to notmuch), with msmtp for sending mail move mails according to the tags (afew) Once everything is setup, you will only need to run notmuch new.\n"><title>Mail with notmuch</title>
<link rel=canonical href=https://alexis.praga.dev/p/mail-with-notmuch/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Mail with notmuch"><meta property='og:description' content=" Today, we will see how to read and mails locally for fast search. Using the powerful notmuch, a local database will be created. By default, notmuch do not move or remove mails but just operate on tags. 5 steps are needed:\nsynchronize mail locally (mbsync) index and tag mail (notmuch) use an email client (emacs interface to notmuch), with msmtp for sending mail move mails according to the tags (afew) Once everything is setup, you will only need to run notmuch new.\n"><meta property='og:url' content='https://alexis.praga.dev/p/mail-with-notmuch/'><meta property='og:site_name' content="Alexis' blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2020-10-01T00:00:00+00:00'><meta property='article:modified_time' content='2020-10-01T00:00:00+00:00'><meta name=twitter:title content="Mail with notmuch"><meta name=twitter:description content=" Today, we will see how to read and mails locally for fast search. Using the powerful notmuch, a local database will be created. By default, notmuch do not move or remove mails but just operate on tags. 5 steps are needed:\nsynchronize mail locally (mbsync) index and tag mail (notmuch) use an email client (emacs interface to notmuch), with msmtp for sending mail move mails according to the tags (afew) Once everything is setup, you will only need to run notmuch new.\n"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/koala_hu_8c43e39eeef8c79d.webp width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>üç•</span></figure><div class=site-meta><h1 class=site-name><a href=/>Alexis' blog</a></h1><h2 class=site-description>PhD in Computer Science, M. D in Molecular Genetics</h2></div></header><ol class=menu-social><li><a href=https://github.com/apraga target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/about-me/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>About me</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#synchronize-mail-locally-mbsync>Synchronize mail locally (mbsync)</a></li><li><a href=#index-and-tag-mail-notmuch>Index and tag mail (<code class=verbatim>notmuch</code>)</a></li><li><a href=#use-an-email-client-notmuch-emacs>Use an email client (<code class=verbatim>notmuch-emacs</code>)</a><ul><li><a href=#msmtp-for-sending-mail><code class=verbatim>msmtp</code> for sending mail</a></li></ul></li><li><a href=#move-mails-according-to-the-tags-afew>Move mails according to the tags (<code class=verbatim>afew</code>)</a></li><li><a href=#putting-everything-together>Putting everything together</a></li></ul></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/mail-with-notmuch/>Mail with notmuch</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 01, 2020</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>3 minute read</time></div></footer></div></header><section class=article-content><p>Today, we will see how to read and mails locally for fast search. Using
the powerful <code class=verbatim>notmuch</code>, a local database will be created. By default,
<code class=verbatim>notmuch</code> do not move or remove mails but just operate on tags. 5 steps
are needed:</p><ol><li>synchronize mail locally (<code class=verbatim>mbsync</code>)</li><li>index and tag mail (<code class=verbatim>notmuch</code>)</li><li>use an email client (emacs interface to <code class=verbatim>notmuch</code>), with <code class=verbatim>msmtp</code> for
sending mail</li><li>move mails according to the tags (<code class=verbatim>afew</code>)</li></ol><p>Once everything is setup, you will only need to run <code class=verbatim>notmuch new</code>.</p><p><em>Updated on: 2025-02-20</em></p><div id=outline-container-synchronize-mail-locally-mbsync class=outline-3><h3 id=synchronize-mail-locally-mbsync>Synchronize mail locally (mbsync)</h3><div id=outline-text-synchronize-mail-locally-mbsync class=outline-text-3><p>Mbsync setup with an Infomaniak email account with the following
<code class=verbatim>~/.mbsyncrc</code>. The list of folders is hardcoded in <code class=verbatim>Patterns</code>:</p><div class="src src-sh"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>IMAPAccount infomaniak
</span></span><span class=line><span class=cl>Host mail.infomaniak.com
</span></span><span class=line><span class=cl>Port <span class=m>993</span>
</span></span><span class=line><span class=cl>User <span class=nv>$USER</span>
</span></span><span class=line><span class=cl>Pass  <span class=nv>$PASS</span>
</span></span><span class=line><span class=cl>SSLType IMAPS
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>IMAPStore info-remote
</span></span><span class=line><span class=cl>Account infomaniak
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>MaildirStore info-local
</span></span><span class=line><span class=cl>Path ~/mail/
</span></span><span class=line><span class=cl>Inbox ~/mail/INBOX/
</span></span><span class=line><span class=cl>Subfolders Verbatim
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Channel info
</span></span><span class=line><span class=cl>Far :info-remote:
</span></span><span class=line><span class=cl>Near :info-local:
</span></span><span class=line><span class=cl>Patterns INBOX Archives Drafts Sent Spam Trash
</span></span><span class=line><span class=cl>Create Both
</span></span><span class=line><span class=cl>Expunge Both
</span></span><span class=line><span class=cl>SyncState *</span></span></code></pre></td></tr></table></div></div></div><p>Try it with <code class=verbatim>mbsync -a</code>.</p></div></div><div id=outline-container-index-and-tag-mail-notmuch class=outline-3><h3 id=index-and-tag-mail-notmuch>Index and tag mail (<code class=verbatim>notmuch</code>)</h3><div id=outline-text-index-and-tag-mail-notmuch class=outline-text-3><p>For faster search, we create a local database for mails. This adds
another layer on our stack as we will need to synchronize the database
with locat files. <code class=verbatim>notmuch</code> do not delete files ! Configuration is
simple:</p><div class="src src-sh"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>notmuch init</span></span></code></pre></td></tr></table></div></div></div></div></div><div id=outline-container-use-an-email-client-notmuch-emacs class=outline-3><h3 id=use-an-email-client-notmuch-emacs>Use an email client (<code class=verbatim>notmuch-emacs</code>)</h3><div id=outline-text-use-an-email-client-notmuch-emacs class=outline-text-3><p>with <code class=verbatim>doom-emacs</code>, enable the <code class=verbatim>notmuch</code> interface in
<code class=verbatim>~/.config/doom.d/init.el</code></p><div class="src src-lisp"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=cl>       <span class=ss>:email</span>
</span></span><span class=line><span class=cl>       <span class=nv>notmuch</span></span></span></code></pre></td></tr></table></div></div></div><p>Some setup is required for inbox: I want mails tagged as "new" only.
Then archiving and deleting should remove the appropriate tags (note:
afew should) Deleting is done either with <code class=verbatim>d</code> (adds <code class=verbatim>+deleted</code>) or
<code class=verbatim>SPC m d</code> (call <code class=verbatim>+notmuch-delete-tags</code> defined below).</p><div class="src src-lisp"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=cl><span class=c1>;; Mail settings</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nv>after!</span> <span class=nv>notmuch</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=k>setq</span> <span class=nv>+notmuch-sync-backend</span> <span class=s>&#34;notmuch new&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>+notmuch-delete-tags</span> <span class=o>&#39;</span><span class=p>(</span><span class=s>&#34;+deleted&#34;</span> <span class=s>&#34;-inbox&#34;</span> <span class=s>&#34;-new&#34;</span> <span class=s>&#34;-unread&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>+notmuch-home-function</span> <span class=p>(</span><span class=nb>lambda</span> <span class=p>()</span> <span class=p>(</span><span class=nv>notmuch-search</span> <span class=s>&#34;tag:new&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nv>notmuch-archive-tags</span> <span class=o>&#39;</span><span class=p>(</span><span class=s>&#34;+archive&#34;</span> <span class=s>&#34;-inbox&#34;</span> <span class=s>&#34;-new&#34;</span> <span class=s>&#34;-unread&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=k>setq</span> <span class=nv>sendmail-program</span> <span class=s>&#34;/usr/bin/msmtp&#34;</span> <span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div><div id=outline-container-msmtp-for-sending-mail class=outline-4><h4 id=msmtp-for-sending-mail><code class=verbatim>msmtp</code> for sending mail</h4><div id=outline-text-msmtp-for-sending-mail class=outline-text-4><p>A simple version with password stored in plain text: ~/.msmtprc</p><pre class=example>
defaults
auth           on
tls            on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
logfile        ~/.msmtp.log

account        infomaniak
host           mail.infomaniak.com
port           465
tls_starttls   off
from           $EMAIL
user           $EMAIL
password       $PASS

account default: infomaniak
</pre><p>Change permissions</p><div class="src src-sh"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ chmod <span class=m>600</span> ~/.msmtprc</span></span></code></pre></td></tr></table></div></div></div><p>Test it with :</p><div class="src src-sh"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;this is some content2&#34;</span> <span class=p>|</span> msmtp -a infomaniak -- <span class=nv>$EMAIL</span></span></span></code></pre></td></tr></table></div></div></div></div></div></div></div><div id=outline-container-move-mails-according-to-the-tags-afew class=outline-3><h3 id=move-mails-according-to-the-tags-afew>Move mails according to the tags (<code class=verbatim>afew</code>)</h3><div id=outline-text-move-mails-according-to-the-tags-afew class=outline-text-3><p><code class=verbatim>notmuch</code> will not rename or move files around. <code class=verbatim>afew</code> offers an easy
way to do that. I use the default filters and I move files accordingly.</p><pre class=example>
# This is the default filter chain
[SpamFilter]
[KillThreadsFilter]
[ListMailsFilter]
[ArchiveSentMailsFilter]

# Disable default behavior (all message not spam and not &#39;killed&#39; have the inbox tag)
# [InboxFilter]

# Assume afew is run with --new
[Filter.1]
message = &#39;Remove new tag for archived and trashed mail&#39;
query = folder:Archives OR tag:archive OR folder:Trash or tag:deleted
tags = -new;+archive

[MailMover]
folders = INBOX Archives
rename = True

# rules
# Assume afew is run with --new
INBOX = &#39;tag:deleted&#39;:Trash &#39;tag:archive&#39;:Archives
Archives = &#39;tag:deleted&#39;:Trash
</pre></div></div><div id=outline-container-putting-everything-together class=outline-3><h3 id=putting-everything-together>Putting everything together</h3><div id=outline-text-putting-everything-together class=outline-text-3><p>Create <code class=verbatim>~/mail/.notmuch/hooks/pre-new</code> with</p><pre class=example>
#!/bin/sh
mbsync -a
</pre><p>Create <code class=verbatim>~/mail/.notmuch/hooks/post-new</code> with</p><pre class=example>
#!/bin/sh
afew --new --tag 
afew --new --move
</pre><p>Make both files executables with <code class=verbatim>chmod +x</code>. Then <code class=verbatim>notmuch new</code> will
sync first, add tags and use <code class=verbatim>afew</code> for cleanup !</p></div></div></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Alexis' blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>